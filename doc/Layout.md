# Object Layout in Heap

## Layout of Class Instance

When allocating objects, the return value is the address of classIndex. Extra slots are allocated before object data, and are used to store metadata such as the size of the object and the index of JClass in method area.

|    name    | position (in slots) |                 description                  |
| :--------: | :-----------------: | :------------------------------------------: |
|    size    |         -2          |             size of object data              |
| classIndex |         -1          | index of corresponding JClass in method area |
|    data    |     0...size-1      |                                              |

The fields of super class are positioned before those of this class.

| class  |  position (inclusive)  |
| :----: | :--------------------: |
| Object |  0...sizeof(Object)-1  |
|  ...   |          ...           |
| Parent | n-sizeof(Parent)...n-1 |
|  This  |   n...n+sizeof(This)   |

## Layout of Arrays

The length field of an array are put before its elements.

|    name    |    position (in slots)    |                 descriptrion                 |
| :--------: | :-----------------------: | :------------------------------------------: |
|    size    |            -2             |             size of object data              |
| classIndex |            -1             | index of corresponding JClass in method area |
|   Object   |   0...sizeof(Object)-1    |               fields of Object               |
|   length   |      sizeof(Object)       |                 array length                 |
|  elements  | sizeof(Object)+1...size-1 |                                              |

The size of certain types of elements in arrays are smaller than a slot.
The size of elements in total is ```ceil(count / elemPerSlot)```.

|  type   | elements per slot |
| :-----: | :---------------: |
|  byte   |         4         |
|  char   |         2         |
| double  |        1/2        |
|  float  |         1         |
|   int   |         1         |
|  long   |        1/2        |
|  short  |         2         |
| boolean |         4         |

## Layout of the Class Object

When creating an Class object, we insert a referencedClassIndex field at the end of this object, which is the index of referenced class in method area.

|         name         | position |          description          |
| :------------------: | :------: | :---------------------------: |
|         size         |    -2    |                               |
|      classIndex      |    -1    |  index of the “Class” class   |
|     otherFields      | 0…size-2 |                               |
| referencedClassIndex |  size-1  | index of the referenced class |

